<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Dashboard - E-Rapot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-xl z-10">
        <div class="p-6 border-b border-slate-800">
            <h2 class="text-xl font-bold tracking-wide">E-Rapot Guru</h2>
            <p id="guruNameSidebar" class="text-slate-400 text-sm mt-1">Loading...</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="flex items-center gap-3 px-4 py-3 bg-blue-600 rounded-lg text-white shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                Input Nilai
            </a>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="flex items-center gap-2 text-slate-400 hover:text-red-400 transition w-full px-4 py-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                Keluar
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div class="md:hidden bg-white p-4 shadow flex justify-between items-center z-20">
            <h1 class="font-bold text-slate-800">Input Nilai</h1>
            <button onclick="logout()" class="text-red-500 text-sm font-medium">Keluar</button>
        </div>

        <div class="flex-1 overflow-auto p-6 md:p-8">
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Mata Pelajaran</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div class="col-span-1 lg:col-span-2">
                        <select id="mapelSelect" onchange="loadData()" class="w-full rounded-lg border-slate-300 border px-4 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm text-slate-700 bg-slate-50">
                            <option value="">-- Pilih Mapel --</option>
                        </select>
                    </div>
                    
                    <button onclick="downloadTemplate()" class="flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download Template
                    </button>
                    
                    <div class="relative group">
                        <button onclick="document.getElementById('fileExcel').click()" class="w-full flex items-center justify-center gap-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2.5 rounded-lg text-sm font-medium transition shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3 3v12"/></svg>
                            Upload Excel
                        </button>
                        <input type="file" id="fileExcel" hidden onchange="importExcel(this)">
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-2 italic">*Pastikan mengupload file template yang sesuai dengan mapel yang dipilih.</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200" id="nilaiTable">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-64">Nama Siswa</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold text-slate-500 uppercase">Hadir</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold text-slate-500 uppercase">Tugas</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold text-slate-500 uppercase">UH 1</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold text-slate-500 uppercase">UH 2</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold text-slate-500 uppercase">UH 3</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold text-slate-500 uppercase">PAS</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-slate-800 uppercase bg-slate-100 border-l">Nilai Akhir</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-100 text-sm">
                            <tr><td colspan="8" class="px-6 py-10 text-center text-slate-500">Silakan pilih mapel diatas untuk memulai input nilai.</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex justify-end">
                    <button onclick="simpanKeDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg shadow-sm transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                        Simpan Semua Perubahan
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const supabaseUrl = 'https://mpimmgzdwfwvfhefsixr.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1waW1tZ3pkd2Z3dmZoZWZzaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTIzNzksImV4cCI6MjA4MzQyODM3OX0.EGneJjR7IWEyrq8s0mWd5mR9B9B73G5jWyadEY4oHgk'
        const db = supabase.createClient(supabaseUrl, supabaseKey)

        let currentSiswa = [];
        let currentGuruId = localStorage.getItem('guru_id');

        async function init() {
            if (!currentGuruId) { window.location.href = 'index.html'; return; }
            document.getElementById('guruNameSidebar').innerText = localStorage.getItem('guru_nama');

            let { data: mapels } = await db.from('mapel').select('*').order('nama_mapel');
            let htmlMapel = '<option value="">-- Pilih Mapel --</option>';
            mapels.forEach(m => htmlMapel += `<option value="${m.id}">${m.nama_mapel} (${m.nama_arab || '-'})</option>`);
            document.getElementById('mapelSelect').innerHTML = htmlMapel;

            let { data: siswas } = await db.from('siswa').select('*').eq('kelas', '10A').order('nama');
            currentSiswa = siswas;
        }

        async function loadData() {
            const mapelId = document.getElementById('mapelSelect').value;
            const tbody = document.querySelector('#nilaiTable tbody');
            if (!mapelId) return;

            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-500">Mengambil data nilai...</td></tr>';

            let { data: nilais } = await db.from('nilai').select('*').eq('mapel_id', mapelId).eq('guru_id', currentGuruId);

            let html = '';
            // Style Input Modern
            const inpClass = "w-full text-center border-slate-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 py-2 px-1 text-slate-700 bg-slate-50 focus:bg-white transition text-sm";
            
            currentSiswa.forEach(siswa => {
                let nilai = nilais.find(n => n.siswa_id == siswa.id) || {};
                const val = (v) => (v !== undefined && v !== null) ? v : '';

                html += `
                <tr data-siswa-id="${siswa.id}" class="hover:bg-slate-50 transition border-b border-slate-100">
                    <td class="px-6 py-3 font-medium text-slate-700">${siswa.nama}</td>
                    <td class="p-2"><input type="number" class="inp-hadir ${inpClass}" value="${val(nilai.kehadiran)}" oninput="hitungRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-tugas ${inpClass}" value="${val(nilai.tugas)}" oninput="hitungRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-uh1 ${inpClass}" value="${val(nilai.uh1)}" oninput="hitungRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-uh2 ${inpClass}" value="${val(nilai.uh2)}" oninput="hitungRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-uh3 ${inpClass}" value="${val(nilai.uh3)}" oninput="hitungRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-pas ${inpClass}" value="${val(nilai.pas_pat)}" oninput="hitungRow(this)"></td>
                    <td class="px-6 py-3 text-center font-bold text-slate-800 bg-slate-100 border-l nilai-akhir">${val(nilai.nilai_akhir)}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
            document.querySelectorAll('tr[data-siswa-id]').forEach(row => hitungRow(row.querySelector('input')));
        }

        function hitungRow(element) {
            let row = element.closest('tr');
            let getVal = (selector) => parseFloat(row.querySelector(selector).value) || 0;
            
            let hadir = getVal('.inp-hadir');
            let tugas = getVal('.inp-tugas');
            let uh1 = getVal('.inp-uh1');
            let uh2 = getVal('.inp-uh2');
            let uh3 = getVal('.inp-uh3');
            let pas = getVal('.inp-pas');

            // Hitung Rata UH (dari kolom yg diisi saja)
            let countUh = 0, sumUh = 0;
            if (row.querySelector('.inp-uh1').value !== '') { sumUh += uh1; countUh++; }
            if (row.querySelector('.inp-uh2').value !== '') { sumUh += uh2; countUh++; }
            if (row.querySelector('.inp-uh3').value !== '') { sumUh += uh3; countUh++; }
            let rataUh = countUh > 0 ? (sumUh / countUh) : 0;

            let akhir = (hadir * 0.10) + (tugas * 0.20) + (rataUh * 0.40) + (pas * 0.30);
            
            let elAkhir = row.querySelector('.nilai-akhir');
            elAkhir.innerText = akhir.toFixed(2);
            elAkhir.className = akhir < 75 ? "px-6 py-3 text-center font-bold bg-red-50 text-red-600 border-l nilai-akhir" : "px-6 py-3 text-center font-bold bg-slate-100 text-slate-800 border-l nilai-akhir";
        }

        // --- FITUR VALIDASI EXCEL ---
        function downloadTemplate() {
            const mapelId = document.getElementById('mapelSelect').value;
            if (!mapelId) return alert("Harap pilih Mapel terlebih dahulu!");

            let dataExcel = currentSiswa.map(s => ({
                "ID_SISTEM": s.id,
                "MAPEL_LOCK": mapelId, // <--- INI KUNCI PENGAMANNYA
                "NAMA_SISWA": s.nama,
                "HADIR": "", "TUGAS": "", "UH_1": "", "UH_2": "", "UH_3": "", "PAS": ""
            }));

            let ws = XLSX.utils.json_to_sheet(dataExcel);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "InputNilai");
            let namaMapel = document.getElementById('mapelSelect').options[document.getElementById('mapelSelect').selectedIndex].text;
            XLSX.writeFile(wb, `Template_${namaMapel.split('(')[0].trim()}.xlsx`);
        }

        function importExcel(input) {
            const mapelId = document.getElementById('mapelSelect').value;
            let file = input.files[0];
            if (!file) return;

            let reader = new FileReader();
            reader.onload = function(e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, {type: 'array'});
                let sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                input.value = ''; 

                let validCount = 0;
                let errorMapel = false;

                sheetData.forEach(row => {
                    // VALIDASI: Cek apakah ID Mapel di Excel sama dengan yang dipilih di Dropdown
                    if (row.MAPEL_LOCK != mapelId) {
                        errorMapel = true;
                        return;
                    }

                    let tr = document.querySelector(`tr[data-siswa-id="${row.ID_SISTEM}"]`);
                    if (tr) {
                        if(row.HADIR !== undefined) tr.querySelector('.inp-hadir').value = row.HADIR;
                        if(row.TUGAS !== undefined) tr.querySelector('.inp-tugas').value = row.TUGAS;
                        if(row.UH_1 !== undefined) tr.querySelector('.inp-uh1').value = row.UH_1;
                        if(row.UH_2 !== undefined) tr.querySelector('.inp-uh2').value = row.UH_2;
                        if(row.UH_3 !== undefined) tr.querySelector('.inp-uh3').value = row.UH_3;
                        if(row.PAS !== undefined) tr.querySelector('.inp-pas').value = row.PAS;
                        hitungRow(tr.querySelector('input'));
                        validCount++;
                    }
                });

                if (errorMapel) {
                    alert("⛔ ERROR FATAL: File Excel ini BUKAN untuk mata pelajaran yang sedang Anda pilih!\nSistem menolak import untuk mencegah kesalahan data.");
                } else if (validCount > 0) {
                    alert(`✅ Sukses membaca ${validCount} data siswa.`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function simpanKeDatabase() {
            // ... Logic Simpan sama persis seperti sebelumnya ...
            // Agar kode tidak terlalu panjang, saya skip copy paste bagian ini karena tidak berubah.
            // Pindahkan logic simpanKeDatabase() yang lama kesini.
            const mapelId = document.getElementById('mapelSelect').value;
            if (!mapelId) return alert("Pilih Mapel dulu!");
            let rows = document.querySelectorAll('tr[data-siswa-id]');
            let dataToUpsert = [];
            rows.forEach(row => {
                let val = (cls) => { let v = row.querySelector(cls).value; return v === '' ? null : parseFloat(v); };
                dataToUpsert.push({
                    siswa_id: row.getAttribute('data-siswa-id'), mapel_id: mapelId, guru_id: currentGuruId,
                    kehadiran: val('.inp-hadir'), tugas: val('.inp-tugas'),
                    uh1: val('.inp-uh1'), uh2: val('.inp-uh2'), uh3: val('.inp-uh3'), pas_pat: val('.inp-pas'),
                    nilai_akhir: parseFloat(row.querySelector('.nilai-akhir').innerText) || 0
                });
            });
            await db.from('nilai').delete().eq('mapel_id', mapelId).in('siswa_id', currentSiswa.map(s=>s.id));
            const { error } = await db.from('nilai').insert(dataToUpsert);
            if (error) alert("Gagal: " + error.message); else alert("✅ Data Tersimpan!");
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        init();
    </script>
</body>
</html>