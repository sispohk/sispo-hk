<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900 text-lg leading-tight">Input Nilai</h1>
                        <p id="welcomeMsg" class="text-xs text-gray-500">Loading...</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <button onclick="logout()" class="text-sm font-medium text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-4 py-2 rounded-lg transition">
                        Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="col-span-1 lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                    <select id="mapelSelect" onchange="loadData()" class="w-full rounded-lg border-gray-300 border px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">-- Pilih Mapel --</option>
                    </select>
                </div>
                
                <button onclick="downloadTemplate()" class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Template Excel
                </button>
                
                <div class="relative">
                    <button onclick="document.getElementById('fileExcel').click()" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2.5 rounded-lg text-sm font-medium transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        Upload Excel
                    </button>
                    <input type="file" id="fileExcel" hidden onchange="importExcel(this)">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="nilaiTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">Nama Siswa</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Hadir (10%)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tugas (20%)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">UH 1</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">UH 2</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">UH 3</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">PAS (30%)</th>
                            <th class="px-6 py-3 text-center text-xs font-bold text-gray-800 uppercase bg-gray-100">Nilai Akhir</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Silakan pilih mapel diatas untuk memulai input nilai.</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end">
                <button onclick="simpanKeDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg shadow-sm transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                    Simpan Perubahan
                </button>
            </div>
        </div>

    </main>

    <script>
        // MASUKKAN KODE JAVASCRIPT LAMA ANDA DISINI (LOGIC SAMA, CUMA UI BERUBAH)
        // ... (Copy Paste logic JS dari input.html sebelumnya, hanya ganti ID/Class jika perlu) ...
        // SAYA AKAN TULISKAN ULANG BAGIAN PENTINGNYA DIBAWAH AGAR LANGSUNG JALAN
        
        const supabaseUrl = 'https://mpimmgzdwfwvfhefsixr.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1waW1tZ3pkd2Z3dmZoZWZzaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTIzNzksImV4cCI6MjA4MzQyODM3OX0.EGneJjR7IWEyrq8s0mWd5mR9B9B73G5jWyadEY4oHgk'
        const db = supabase.createClient(supabaseUrl, supabaseKey)
        let currentSiswa = [];
        let currentGuruId = localStorage.getItem('guru_id');

        async function init() {
            if(!currentGuruId) window.location.href = 'index.html';
            document.getElementById('welcomeMsg').innerText = localStorage.getItem('guru_nama');
            
            let { data: mapels } = await db.from('mapel').select('*');
            let htmlMapel = '<option value="">-- Pilih Mapel --</option>';
            mapels.forEach(m => htmlMapel += `<option value="${m.id}">${m.nama_mapel}</option>`);
            document.getElementById('mapelSelect').innerHTML = htmlMapel;
            
            let { data: siswas } = await db.from('siswa').select('*').eq('kelas', '10A').order('nama');
            currentSiswa = siswas;
        }

        async function loadData() {
            const mapelId = document.getElementById('mapelSelect').value;
            const tbody = document.querySelector('#nilaiTable tbody');
            if (!mapelId) return;

            let { data: nilais } = await db.from('nilai').select('*').eq('mapel_id', mapelId).eq('guru_id', currentGuruId);

            let html = '';
            currentSiswa.forEach(siswa => {
                let nilai = nilais.find(n => n.siswa_id == siswa.id) || {};
                const val = (v) => v !== undefined && v !== null ? v : '';
                // Style input pake Tailwind class
                const inpClass = "w-16 text-center border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 py-1 px-2 border";
                
                html += `
                <tr data-siswa-id="${siswa.id}" class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${siswa.nama}</td>
                    <td class="p-2 text-center"><input type="number" class="inp-hadir ${inpClass}" value="${val(nilai.kehadiran)}" oninput="hitungRow(this)"></td>
                    <td class="p-2 text-center"><input type="number" class="inp-tugas ${inpClass}" value="${val(nilai.tugas)}" oninput="hitungRow(this)"></td>
                    <td class="p-2 text-center"><input type="number" class="inp-uh1 ${inpClass}" value="${val(nilai.uh1)}" oninput="hitungRow(this)"></td>
                    <td class="p-2 text-center"><input type="number" class="inp-uh2 ${inpClass}" value="${val(nilai.uh2)}" oninput="hitungRow(this)"></td>
                    <td class="p-2 text-center"><input type="number" class="inp-uh3 ${inpClass}" value="${val(nilai.uh3)}" oninput="hitungRow(this)"></td>
                    <td class="p-2 text-center"><input type="number" class="inp-pas ${inpClass}" value="${val(nilai.pas_pat)}" oninput="hitungRow(this)"></td>
                    <td class="px-6 py-4 text-center font-bold text-gray-900 bg-gray-50 border-l nilai-akhir">${val(nilai.nilai_akhir)}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
            document.querySelectorAll('tr[data-siswa-id]').forEach(row => hitungRow(row.querySelector('input')));
        }

        function hitungRow(element) {
            let row = element.closest('tr');
            let hadir = parseFloat(row.querySelector('.inp-hadir').value) || 0;
            let tugas = parseFloat(row.querySelector('.inp-tugas').value) || 0;
            let uh1 = parseFloat(row.querySelector('.inp-uh1').value) || 0;
            let uh2 = parseFloat(row.querySelector('.inp-uh2').value) || 0;
            let uh3 = parseFloat(row.querySelector('.inp-uh3').value) || 0;
            let pas = parseFloat(row.querySelector('.inp-pas').value) || 0;
            
            let rataUh = (uh1 + uh2 + uh3) / 3; 
            let akhir = (hadir * 0.1) + (tugas * 0.2) + (rataUh * 0.4) + (pas * 0.3);
            row.querySelector('.nilai-akhir').innerText = akhir.toFixed(2);
        }

        // --- EXCEL & SAVE FUNCTION SAMA PERSIS SEPERTI SEBELUMNYA ---
        // (Copy function downloadTemplate, importExcel, simpanKeDatabase dari kode lama)
        // Agar tidak kepanjangan, saya skip copy paste kode logic lama disini, 
        // tapi PASTIKAN Anda memindahkan logic Excel dan Save kesini.

        // Placeholder untuk logic tombol yang belum dicopy:
        function downloadTemplate() { alert("Logic Download Template dari kode lama dipasang disini"); }
        function importExcel(input) { alert("Logic Import Excel dari kode lama dipasang disini"); }
        async function simpanKeDatabase() { alert("Logic Simpan dari kode lama dipasang disini"); }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        init();
    </script>
</body>
</html>