<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900 text-lg leading-tight">Input Nilai</h1>
                        <p id="welcomeMsg" class="text-xs text-gray-500">Loading...</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <button onclick="logout()" class="text-sm font-medium text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-4 py-2 rounded-lg transition">
                        Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="col-span-1 lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                    <select id="mapelSelect" onchange="loadData()" class="w-full rounded-lg border-gray-300 border px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">-- Pilih Mapel --</option>
                    </select>
                </div>
                
                <button onclick="downloadTemplate()" class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Template Excel
                </button>
                
                <div class="relative">
                    <button onclick="document.getElementById('fileExcel').click()" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2.5 rounded-lg text-sm font-medium transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        Upload Excel
                    </button>
                    <input type="file" id="fileExcel" hidden onchange="importExcel(this)">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="nilaiTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-64">Nama Siswa</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Hadir (10%)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tugas (20%)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">UH 1</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">UH 2</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">UH 3</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">PAS (30%)</th>
                            <th class="px-6 py-3 text-center text-xs font-bold text-gray-800 uppercase bg-gray-100">Nilai Akhir</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Silakan pilih mapel diatas untuk memulai input nilai.</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end">
                <button onclick="simpanKeDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-lg shadow-sm transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                    Simpan Perubahan
                </button>
            </div>
        </div>

    </main>

    <script>        
        const supabaseUrl = 'https://mpimmgzdwfwvfhefsixr.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1waW1tZ3pkd2Z3dmZoZWZzaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTIzNzksImV4cCI6MjA4MzQyODM3OX0.EGneJjR7IWEyrq8s0mWd5mR9B9B73G5jWyadEY4oHgk'
        const db = supabase.createClient(supabaseUrl, supabaseKey)
        
        // Variabel Global
        let currentSiswa = [];
        let currentGuruId = localStorage.getItem('guru_id');

        // --- 1. INISIALISASI HALAMAN ---
        async function init() {
            // Cek Login
            if (!currentGuruId) {
                alert("Sesi habis, silakan login kembali.");
                window.location.href = 'index.html';
                return;
            }
            
            // Tampilkan Nama Guru
            document.getElementById('welcomeMsg').innerText = "Login sebagai: " + (localStorage.getItem('guru_nama') || 'Guru');

            // Load Data Mapel
            let { data: mapels } = await db.from('mapel').select('*').order('nama_mapel');
            let htmlMapel = '<option value="">-- Pilih Mapel --</option>';
            
            mapels.forEach(m => {
                // Tampilkan Nama Mapel (plus Nama Arabnya biar keren)
                htmlMapel += `<option value="${m.id}">${m.nama_mapel} (${m.nama_arab || '-'})</option>`;
            });
            document.getElementById('mapelSelect').innerHTML = htmlMapel;

            // Load Data Siswa (Default Kelas 10A dulu)
            let { data: siswas } = await db.from('siswa').select('*').eq('kelas', '10A').order('nama');
            currentSiswa = siswas;
        }

        // --- 2. LOAD NILAI DARI DATABASE ---
        async function loadData() {
            const mapelId = document.getElementById('mapelSelect').value;
            const tbody = document.querySelector('#nilaiTable tbody');
            
            if (!mapelId) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-10 text-center text-gray-500">Silakan pilih mapel diatas untuk memulai input nilai.</td></tr>';
                return;
            }

            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">Mengambil data nilai...</td></tr>';

            // Ambil nilai yang sudah tersimpan
            let { data: nilais } = await db.from('nilai')
                .select('*')
                .eq('mapel_id', mapelId)
                .eq('guru_id', currentGuruId); // Filter berdasarkan mapel & guru

            // Render Tabel
            let html = '';
            const inpClass = "w-full text-center border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 py-1.5 px-2 border shadow-sm text-sm";
            
            currentSiswa.forEach(siswa => {
                let nilai = nilais.find(n => n.siswa_id == siswa.id) || {};
                const val = (v) => (v !== undefined && v !== null) ? v : '';

                html += `
                <tr data-siswa-id="${siswa.id}" class="hover:bg-gray-50 transition border-b border-gray-100">
                    <td class="px-6 py-3 whitespace-nowrap font-medium text-gray-800 text-sm">${siswa.nama}</td>
                    <td class="p-2"><input type="number" class="inp-hadir ${inpClass}" value="${val(nilai.kehadiran)}" oninput="hitungRow(this)" placeholder="0"></td>
                    <td class="p-2"><input type="number" class="inp-tugas ${inpClass}" value="${val(nilai.tugas)}" oninput="hitungRow(this)" placeholder="0"></td>
                    <td class="p-2"><input type="number" class="inp-uh1 ${inpClass}" value="${val(nilai.uh1)}" oninput="hitungRow(this)" placeholder="0"></td>
                    <td class="p-2"><input type="number" class="inp-uh2 ${inpClass}" value="${val(nilai.uh2)}" oninput="hitungRow(this)" placeholder="0"></td>
                    <td class="p-2"><input type="number" class="inp-uh3 ${inpClass}" value="${val(nilai.uh3)}" oninput="hitungRow(this)" placeholder="0"></td>
                    <td class="p-2"><input type="number" class="inp-pas ${inpClass}" value="${val(nilai.pas_pat)}" oninput="hitungRow(this)" placeholder="0"></td>
                    <td class="px-6 py-3 text-center font-bold text-gray-900 bg-gray-50 border-l nilai-akhir">${val(nilai.nilai_akhir)}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
            // Hitung ulang tampilan agar sinkron
            document.querySelectorAll('tr[data-siswa-id]').forEach(row => hitungRow(row.querySelector('input')));
        }

        // --- 3. RUMUS HITUNG (Realtime) ---
        function hitungRow(element) {
            let row = element.closest('tr');
            
            // Ambil value, default 0 jika kosong
            let getVal = (selector) => parseFloat(row.querySelector(selector).value) || 0;

            let hadir = getVal('.inp-hadir');
            let tugas = getVal('.inp-tugas');
            let uh1 = getVal('.inp-uh1');
            let uh2 = getVal('.inp-uh2');
            let uh3 = getVal('.inp-uh3');
            let pas = getVal('.inp-pas');

            // Logika Rata-rata UH:
            // Jika hanya diisi UH1, pembaginya 1. Jika UH1 & UH2, pembagi 2.
            // TAPI, sesuai request sebelumnya "rerata uh" biasanya dibagi slot yang disediakan (misal 3) atau dibagi jumlah yg diisi.
            // Untuk amannya kita bagi 3 fixed (sesuai kolom Excel) ATAU kita bagi jumlah yg diisi (lebih adil).
            // Mari kita pakai: Rata-rata dari kolom UH yang TIDAK KOSONG.
            
            let countUh = 0;
            let sumUh = 0;
            if (row.querySelector('.inp-uh1').value !== '') { sumUh += uh1; countUh++; }
            if (row.querySelector('.inp-uh2').value !== '') { sumUh += uh2; countUh++; }
            if (row.querySelector('.inp-uh3').value !== '') { sumUh += uh3; countUh++; }
            
            let rataUh = countUh > 0 ? (sumUh / countUh) : 0;

            // Rumus: 10% Hadir + 20% Tugas + 40% Rerata UH + 30% PAS
            let akhir = (hadir * 0.10) + (tugas * 0.20) + (rataUh * 0.40) + (pas * 0.30);

            // Update UI
            let elAkhir = row.querySelector('.nilai-akhir');
            elAkhir.innerText = akhir.toFixed(2); // 2 Desimal
            
            // Visual Feedback (Warna Merah jika dibawah KKM 75)
            if(akhir < 75) {
                elAkhir.classList.add('text-red-600');
                elAkhir.classList.remove('text-gray-900');
            } else {
                elAkhir.classList.remove('text-red-600');
                elAkhir.classList.add('text-gray-900');
            }
        }

        // --- 4. FITUR DOWNLOAD TEMPLATE EXCEL ---
        function downloadTemplate() {
            const mapelId = document.getElementById('mapelSelect').value;
            if (!mapelId) return alert("Harap pilih Mapel terlebih dahulu!");

            // Siapkan Data JSON
            let dataExcel = currentSiswa.map(s => ({
                "ID_SISTEM": s.id, // JANGAN DIHAPUS (Hidden Key)
                "NAMA_SISWA": s.nama,
                "HADIR_0_100": "",
                "TUGAS": "",
                "UH_1": "",
                "UH_2": "",
                "UH_3": "",
                "PAS_PAT": ""
            }));

            // Buat Worksheet
            let ws = XLSX.utils.json_to_sheet(dataExcel);
            
            // Atur Lebar Kolom Biar Rapi
            ws['!cols'] = [
                {wch: 10}, {wch: 30}, {wch: 15}, {wch: 10}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 10}
            ];

            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "InputNilai");

            // Nama File
            let namaMapel = document.getElementById('mapelSelect').options[document.getElementById('mapelSelect').selectedIndex].text;
            let filename = `Template_Nilai_${namaMapel.replace(/[^a-z0-9]/gi, '_')}.xlsx`;

            XLSX.writeFile(wb, filename);
        }

        // --- 5. FITUR IMPORT EXCEL ---
        function importExcel(input) {
            let file = input.files[0];
            if (!file) return;

            let reader = new FileReader();
            reader.onload = function(e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, {type: 'array'});
                let sheetName = workbook.SheetNames[0];
                let sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                // Reset Input agar bisa upload file yg sama jika perlu revisi
                input.value = ''; 

                let importedCount = 0;
                
                sheetData.forEach(row => {
                    // Cari baris tabel HTML berdasarkan ID Siswa (ID_SISTEM dari Excel)
                    let idSiswa = row.ID_SISTEM;
                    let tr = document.querySelector(`tr[data-siswa-id="${idSiswa}"]`);
                    
                    if (tr) {
                        // Masukkan nilai ke input form
                        if(row.HADIR_0_100 !== undefined) tr.querySelector('.inp-hadir').value = row.HADIR_0_100;
                        if(row.TUGAS !== undefined) tr.querySelector('.inp-tugas').value = row.TUGAS;
                        if(row.UH_1 !== undefined) tr.querySelector('.inp-uh1').value = row.UH_1;
                        if(row.UH_2 !== undefined) tr.querySelector('.inp-uh2').value = row.UH_2;
                        if(row.UH_3 !== undefined) tr.querySelector('.inp-uh3').value = row.UH_3;
                        if(row.PAS_PAT !== undefined) tr.querySelector('.inp-pas').value = row.PAS_PAT;

                        // Trigger hitung ulang
                        hitungRow(tr.querySelector('input'));
                        importedCount++;
                    }
                });
                
                if(importedCount > 0) {
                    alert(`Berhasil membaca ${importedCount} data siswa dari Excel.\nJangan lupa klik tombol 'Simpan Perubahan' di bawah.`);
                } else {
                    alert("Gagal membaca data. Pastikan Anda menggunakan Template yang benar (Kolom ID_SISTEM jangan diubah).");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 6. SIMPAN DATA KE DATABASE ---
        async function simpanKeDatabase() {
            const mapelId = document.getElementById('mapelSelect').value;
            if (!mapelId) return alert("Pilih Mapel dulu!");

            let rows = document.querySelectorAll('tr[data-siswa-id]');
            let dataToUpsert = [];
            let tombol = document.querySelector('button[onclick="simpanKeDatabase()"]');

            // Ubah tombol jadi Loading
            let textAsli = tombol.innerHTML;
            tombol.innerHTML = "⏳ Menyimpan...";
            tombol.disabled = true;

            rows.forEach(row => {
                let siswaId = row.getAttribute('data-siswa-id');
                
                // Ambil nilai, kosongkan string jika input kosong agar DB mencatat NULL atau 0
                let val = (cls) => {
                    let v = row.querySelector(cls).value;
                    return v === '' ? null : parseFloat(v);
                };

                let nilaiAkhirText = row.querySelector('.nilai-akhir').innerText;

                dataToUpsert.push({
                    siswa_id: siswaId,
                    mapel_id: mapelId,
                    guru_id: currentGuruId,
                    kehadiran: val('.inp-hadir') || 0,
                    tugas: val('.inp-tugas') || 0,
                    uh1: val('.inp-uh1') || 0,
                    uh2: val('.inp-uh2') || 0,
                    uh3: val('.inp-uh3') || 0,
                    pas_pat: val('.inp-pas') || 0,
                    nilai_akhir: parseFloat(nilaiAkhirText) || 0
                });
            });

            // 1. Hapus data lama untuk mapel ini & kelas ini (Metode Clean & Replace)
            // Ini untuk menghindari duplikat jika UPSERT bermasalah di Supabase Client versi lama
            const siswaIds = currentSiswa.map(s => s.id);
            await db.from('nilai')
                .delete()
                .eq('mapel_id', mapelId)
                .in('siswa_id', siswaIds);

            // 2. Insert Data Baru
            const { error } = await db.from('nilai').insert(dataToUpsert);

            // Kembalikan tombol
            tombol.innerHTML = textAsli;
            tombol.disabled = false;

            if (error) {
                alert("Gagal menyimpan: " + error.message);
            } else {
                // Tampilkan notifikasi cantik (Opsional, pakai Alert biasa juga oke)
                alert("✅ Sukses! Data nilai berhasil disimpan ke Database.");
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Jalankan
        init();
    </script>
</body>
</html>