<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Rapot - Pesantren Style</title>
    <meta name="google" content="notranslate">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page { size: A4; margin: 1cm; }
        body { font-family: 'Amiri', serif; margin: 0; padding: 20px; background: white; color: #000; direction: rtl; }
        .header { text-align: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 26px; font-weight: bold; }
        .header h2 { margin: 5px 0; font-size: 18px; font-weight: normal; }
        .biodata { width: 100%; margin-bottom: 20px; font-size: 16px; font-weight: bold; }
        .biodata td { padding: 5px; }
        .category-title { font-size: 18px; font-weight: bold; margin-top: 20px; border-bottom: 1px solid #000; display: inline-block; }
        table.nilai { width: 100%; border-collapse: collapse; font-size: 16px; margin-bottom: 15px; }
        table.nilai th, table.nilai td { border: 1px solid #000; padding: 4px 8px; text-align: center; }
        table.nilai th { background-color: #f0f0f0; }
        table.nilai td.col-mapel { text-align: right; width: 35%; }
        .footer { margin-top: 40px; display: flex; justify-content: space-between; text-align: center; }
        .ttd-box { width: 30%; }
        .ttd-line { margin-top: 60px; border-bottom: 1px solid #000; }
        .no-print { position: fixed; top: 20px; left: 20px; background: #27ae60; color: white; padding: 10px 20px; border: none; cursor: pointer; font-family: sans-serif; }
        @media print { .no-print { display: none; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <button class="no-print" onclick="window.print()">ğŸ–¨ï¸ Cetak PDF</button>

    <div class="header">
        <h1>Ù…Ø¹Ù‡Ø¯ Ø­Ø³Ù† Ø§Ù„Ø®Ø§ØªÙ…Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</h1>
        <h2>PONDOK PESANTREN HUSNUL KHOTIMAH</h2>
        <p>Tahun Ajaran Ù¢Ù Ù¢Ù¥ / Ù¢Ù Ù¢Ù¦ | Semester Ganjil</p>
    </div>

    <table class="biodata">
        <tr>
            <td width="15%">Nama</td><td width="2%">:</td><td id="namaSiswa" style="text-align: right;">-</td>
            <td width="10%">Kelas</td><td width="2%">:</td><td id="kelasSiswa">-</td>
        </tr>
        <tr>
            <td>NIS</td><td>:</td><td id="nisnSiswa">-</td>
            <td>Halaman</td><td>:</td><td>1</td>
        </tr>
    </table>

    <div id="contentArea"><p style="text-align:center;">Memuat data...</p></div>

    <table class="nilai" style="margin-top: 20px; width: 60%; margin-right: auto;">
        <tr>
            <th width="50%">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Jumlah)</th>
            <td id="totalNilai">-</td>
        </tr>
        <tr>
            <th>Ø§Ù„Ù…Ø¹Ø¯Ù„ (Rata-rata)</th>
            <td id="rataNilai">-</td>
        </tr>
        <tr>
            <th>Ø§Ù„ØªØ±ØªÙŠØ¨ (Ranking)</th>
            <td id="rankingSiswa" style="font-weight: bold;">-</td>
        </tr>
    </table>

    <div class="footer">
        <div class="ttd-box"><p>Wali Kelas</p><div class="ttd-line"></div><p id="waliKelasNama">...</p></div>
        <div class="ttd-box"><p>Mudir Ma'had</p><div class="ttd-line"></div><p>KH. Mudir, Lc.</p></div>
        <div class="ttd-box"><p>Orang Tua / Wali</p><div class="ttd-line"></div><p>.........................</p></div>
    </div>

    <script>
        const supabaseUrl = 'https://mpimmgzdwfwvfhefsixr.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1waW1tZ3pkd2Z3dmZoZWZzaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTIzNzksImV4cCI6MjA4MzQyODM3OX0.EGneJjR7IWEyrq8s0mWd5mR9B9B73G5jWyadEY4oHgk'
        const db = supabase.createClient(supabaseUrl, supabaseKey)
        const params = new URLSearchParams(window.location.search);
        const siswaId = params.get('siswa_id');

        // Helper Arab
        const digits = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
        function toArabic(n) { if(n==null || isNaN(n)) return "-"; return n.toString().replace(/\d/g, d => digits[d]); }
        const satuan=["","ÙˆØ§Ø­Ø¯","Ø§Ø«Ù†Ø§Ù†","Ø«Ù„Ø§Ø«Ø©","Ø£Ø±Ø¨Ø¹Ø©","Ø®Ù…Ø³Ø©","Ø³ØªØ©","Ø³Ø¨Ø¹Ø©","Ø«Ù…Ø§Ù†ÙŠØ©","ØªØ³Ø¹Ø©"];
        const belasan=["Ø¹Ø´Ø±","Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±","Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±","Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø®Ù…Ø³Ø© Ø¹Ø´Ø±","Ø³ØªØ© Ø¹Ø´Ø±","Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±","ØªØ³Ø¹Ø© Ø¹Ø´Ø±"];
        const puluhan=["","Ø¹Ø´Ø±Ø©","Ø¹Ø´Ø±ÙˆÙ†","Ø«Ù„Ø§Ø«ÙˆÙ†","Ø£Ø±Ø¨Ø¹ÙˆÙ†","Ø®Ù…Ø³ÙˆÙ†","Ø³ØªÙˆÙ†","Ø³Ø¨Ø¹ÙˆÙ†","Ø«Ù…Ø§Ù†ÙˆÙ†","ØªØ³Ø¹ÙˆÙ†"];
        function textArab(n) {
            n=parseInt(n); if(isNaN(n)) return "-"; if(n==100) return "Ù…Ø§Ø¦Ø©"; if(n==0) return "ØµÙØ±";
            if(n<10) return satuan[n]; if(n<20) return belasan[n-10];
            let s=n%10, p=Math.floor(n/10); return s===0 ? puluhan[p] : satuan[s].replace('Ø©','') + " Ùˆ" + puluhan[p];
        }

        async function loadRapot() {
            if(!siswaId) return alert("ID Siswa hilang!");

            // 1. Load Data
            let { data: siswa } = await db.from('siswa').select('*').eq('id', siswaId).single();
            let { data: catatan } = await db.from('catatan_wali').select('*').eq('siswa_id', siswaId).single();
            
            if(siswa) {
                document.getElementById('namaSiswa').innerText = siswa.nama;
                document.getElementById('kelasSiswa').innerText = siswa.kelas;
                document.getElementById('nisnSiswa').innerText = siswa.nisn || '-';
            }

            let { data: mapels } = await db.from('mapel').select('*').order('id');
            let { data: myNilai } = await db.from('nilai').select('*').eq('siswa_id', siswaId);

            // 2. Data Teman Sekelas (Untuk Ranking)
            let { data: classMates } = await db.from('siswa').select('id').eq('kelas', siswa.kelas);
            let classIds = classMates.map(s => s.id);
            let { data: classNilai } = await db.from('nilai').select('siswa_id, mapel_id, nilai_akhir').in('siswa_id', classIds);

            const getRataKelas = (mid) => {
                let grades = classNilai.filter(g => g.mapel_id == mid && g.nilai_akhir > 0);
                if(grades.length == 0) return 0;
                return Math.round(grades.reduce((a,b)=>a+b.nilai_akhir,0) / grades.length);
            }

            // 3. Render Tabel Nilai
            const cats = [{id:'Lisan',t:'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø´ÙÙˆÙŠ (Lisan)'},{id:'Tulis',t:'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„ØªØ­Ø±ÙŠØ±ÙŠ (Tulis)'},{id:'Tahfidz',t:'Ø§Ù„ØªØ­ÙÙŠØ¸ (Tahfidz)'}];
            let html='', grandTotal=0, countMapel=0;

            cats.forEach(c => {
                let ms = mapels.filter(m => m.kategori == c.id);
                if(ms.length > 0) {
                    html += `<div class="category-title">${c.t}</div>
                    <table class="nilai"><thead><tr>
                        <th width="5%">No</th><th width="35%">Mapel / Ø§Ù„Ù…ÙˆØ§Ø¯</th><th width="10%">Rata Kls</th><th width="10%">Nilai</th><th>Terbilang</th>
                    </tr></thead><tbody>`;
                    ms.forEach((m,i) => {
                        let n = myNilai.find(x => x.mapel_id == m.id);
                        let val = (n && n.nilai_akhir>0) ? Math.round(n.nilai_akhir) : null;
                        let rk = getRataKelas(m.id);
                        if(val !== null) { grandTotal += n.nilai_akhir; countMapel++; }
                        html += `<tr>
                            <td>${toArabic(i+1)}</td>
                            <td class="col-mapel"><span style="float:left;font-size:12px">${m.nama_mapel}</span><b>${m.nama_arab||''}</b></td>
                            <td>${rk>0?toArabic(rk):'-'}</td>
                            <td style="font-weight:bold">${toArabic(val)}</td>
                            <td>${textArab(val)}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                }
            });
            document.getElementById('contentArea').innerHTML = html;

            // Hitung Ranking
            let studentTotals = {};
            classIds.forEach(id => studentTotals[id] = 0);
            classNilai.forEach(g => { if(studentTotals[g.siswa_id]!==undefined) studentTotals[g.siswa_id] += g.nilai_akhir; });
            let rankArray = Object.keys(studentTotals).map(id => ({ id: parseInt(id), total: studentTotals[id] })).sort((a,b) => b.total - a.total);
            let myRank = rankArray.findIndex(r => r.id == parseInt(siswaId)) + 1;

            // 4. TABEL BAWAH (SUMMARY & SIKAP SEJAJAR)
            let totalStr = countMapel>0 ? toArabic(Math.round(grandTotal)) : "-";
            let rataStr = countMapel>0 ? toArabic((grandTotal/countMapel).toFixed(2)) : "-";
            let rankStr = `${toArabic(myRank)} Ù…Ù† ${toArabic(rankArray.length)}`;

            // Data Sikap
            let akhlak = catatan ? catatan.akhlak : "-";
            let sakit = catatan ? toArabic(catatan.sakit) : "-";
            let izin = catatan ? toArabic(catatan.izin) : "-";
            let alpa = catatan ? toArabic(catatan.alpa) : "-";

            let summaryHtml = `
            <div style="display: flex; justify-content: space-between; margin-top: 20px; align-items: flex-start;">
                
                <div style="width: 48%;">
                    <table class="nilai" style="width: 100%;">
                        <tr><th width="60%">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Jumlah)</th><td>${totalStr}</td></tr>
                        <tr><th>Ø§Ù„Ù…Ø¹Ø¯Ù„ (Rata-rata)</th><td>${rataStr}</td></tr>
                        <tr><th>Ø§Ù„ØªØ±ØªÙŠØ¨ (Ranking)</th><td style="font-weight:bold;">${rankStr}</td></tr>
                    </table>
                </div>

                <div style="width: 48%;">
                    <table class="nilai" style="width: 100%;">
                        <tr><th width="60%">Ø§Ù„Ø³Ù„ÙˆÙƒ (Akhlak)</th><td>${akhlak}</td></tr>
                        <tr><th>Ù…Ø±Ø¶ (Sakit)</th><td>${sakit}</td></tr>
                        <tr><th>Ø¥Ø°Ù† (Izin)</th><td>${izin}</td></tr>
                        <tr><th>ØºÙŠØ§Ø¨ (Alpa)</th><td>${alpa}</td></tr>
                    </table>
                </div>

            </div>`;
            
            document.getElementById('contentArea').insertAdjacentHTML('beforeend', summaryHtml);
        }
        loadRapot();
    </script>
</body>
</html>