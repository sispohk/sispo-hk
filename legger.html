<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Dashboard Wali - E-Rapot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; } .fade-in { animation: fadeIn 0.3s ease-in-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }</style>
</head>
<body class="bg-slate-50 min-h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800">
            <h2 class="text-xl font-bold">Wali Kelas 10A</h2>
            <p class="text-slate-400 text-xs mt-1" id="sidebarNama">Loading...</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('legger')" id="navLegger" class="nav-item bg-blue-600 text-white">üìä Legger Nilai</button>
            <button onclick="switchTab('nilaiMapel')" id="navNilaiMapel" class="nav-item text-slate-400 hover:text-white">üìù Input Nilai Mapel</button>
            <button onclick="switchTab('sikap')" id="navSikap" class="nav-item text-slate-400 hover:text-white">‚ù§Ô∏è Sikap & Absen</button>
        </nav>
        <div class="p-4 border-t border-slate-800"><button onclick="logout()" class="text-red-400 text-sm w-full text-left hover:text-white">Keluar</button></div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div class="p-6 md:p-8 flex-1 overflow-auto">
            
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-slate-800" id="pageTitle">Legger Nilai</h1>
                <div id="actionButtons"></div> </div>

            <div id="viewLegger" class="fade-in block">
                <div class="bg-white rounded-xl shadow-sm border overflow-x-auto">
                    <table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr id="headerLegger"></tr></thead><tbody id="bodyLegger" class="divide-y"></tbody></table>
                </div>
            </div>

            <div id="viewNilaiMapel" class="fade-in hidden">
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-bold text-slate-700 mb-1">Pilih Mata Pelajaran Anda</label>
                            <select id="mapelSelect" onchange="loadNilaiMapel()" class="w-full border p-2 rounded bg-slate-50"></select>
                        </div>
                        <button onclick="downloadTemplate()" class="bg-green-600 text-white px-4 py-2 rounded">Template Excel</button>
                        <div class="relative"><button onclick="document.getElementById('fileExcel').click()" class="bg-slate-700 text-white px-4 py-2 rounded">Import Excel</button><input type="file" id="fileExcel" hidden onchange="importExcel(this)"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-sm"><thead class="bg-slate-50"><tr class="text-center"><th class="p-3 text-left">Nama</th><th>Hadir</th><th>Tugas</th><th>UH1</th><th>UH2</th><th>UH3</th><th>PAS</th><th>Akhir</th></tr></thead><tbody id="bodyInputNilai"></tbody></table>
                    <div class="p-4 bg-slate-50 text-right"><button onclick="simpanNilaiMapel()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Simpan Nilai</button></div>
                </div>
            </div>

            <div id="viewSikap" class="fade-in hidden">
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-sm"><thead class="bg-slate-50"><tr class="text-left"><th class="p-3">Nama</th><th class="w-16">Sakit</th><th class="w-16">Izin</th><th class="w-16">Alpa</th><th>Akhlak</th><th>Kepribadian</th></tr></thead><tbody id="bodySikap"></tbody></table>
                    <div class="p-4 bg-slate-50 text-right"><button onclick="simpanSikapMassal()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Simpan Sikap</button></div>
                </div>
            </div>
        </div>
    </main>

    <style>.nav-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; border-radius: 8px; transition: all 0.2s; }</style>

    <script>
        const supabaseUrl = 'https://mpimmgzdwfwvfhefsixr.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1waW1tZ3pkd2Z3dmZoZWZzaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTIzNzksImV4cCI6MjA4MzQyODM3OX0.EGneJjR7IWEyrq8s0mWd5mR9B9B73G5jWyadEY4oHgk'
        const db = supabase.createClient(supabaseUrl, supabaseKey)

        let guruId = localStorage.getItem('guru_id');
        let role = localStorage.getItem('user_role');
        let allSiswa = [], allCatatan = [], mapels = [];

        async function init() {
            if(!guruId) window.location.href = 'index.html';
            document.getElementById('sidebarNama').innerText = localStorage.getItem('guru_nama');

            // Load Master Data
            const { data: s } = await db.from('siswa').select('*').eq('kelas', '10A').order('nama');
            allSiswa = s;
            const { data: m } = await db.from('mapel').select('*').order('id');
            mapels = m;

            // Load Mapel Dropdown (Untuk Tab 2)
            let mapelOpt = '<option value="">-- Pilih Mapel --</option>';
            mapels.forEach(m => mapelOpt += `<option value="${m.id}">${m.nama_mapel}</option>`);
            document.getElementById('mapelSelect').innerHTML = mapelOpt;

            loadLeggerView(); // Default View
        }

        // --- TAB 1: LEGGER ---
        async function loadLeggerView() {
            const { data: nilais } = await db.from('nilai').select('siswa_id, mapel_id, nilai_akhir');
            const header = document.getElementById('headerLegger');
            const body = document.getElementById('bodyLegger');
            
            header.innerHTML = '<th class="p-3 w-10">No</th><th class="p-3">Nama Siswa</th><th class="p-3 text-center">Cetak</th>';
            mapels.forEach(m => header.innerHTML += `<th class="p-3 text-center border-l">${m.nama_mapel}</th>`);
            header.innerHTML += '<th class="p-3 text-center bg-blue-50 text-blue-800">RERATA</th>';

            body.innerHTML = '';
            allSiswa.forEach((s, i) => {
                let html = `<td class="p-3 text-center">${i+1}</td><td class="p-3 font-bold text-slate-700">${s.nama}</td>
                <td class="p-3 text-center"><a href="cetak.html?siswa_id=${s.id}" target="_blank" class="text-blue-600 hover:underline">üñ®Ô∏è</a></td>`;
                
                let tot=0, cnt=0;
                mapels.forEach(m => {
                    let n = nilais.find(x => x.siswa_id == s.id && x.mapel_id == m.id);
                    let val = n ? Math.round(n.nilai_akhir) : '-';
                    if(val !== '-') { tot+=n.nilai_akhir; cnt++; }
                    html += `<td class="p-3 text-center border-l text-slate-600">${val}</td>`;
                });
                let avg = cnt>0 ? (tot/cnt).toFixed(2) : '-';
                html += `<td class="p-3 text-center bg-blue-50 font-bold text-blue-800">${avg}</td>`;
                body.innerHTML += `<tr class="hover:bg-slate-50 border-b">${html}</tr>`;
            });
        }

        // --- TAB 2: INPUT NILAI MAPEL (LOGIC INPUT.HTML LAMA) ---
        async function loadNilaiMapel() {
            const mid = document.getElementById('mapelSelect').value;
            const body = document.getElementById('bodyInputNilai');
            body.innerHTML = '';
            if(!mid) return;

            // Load Nilai dari DB
            const { data: grades } = await db.from('nilai').select('*').eq('mapel_id', mid).eq('guru_id', guruId);
            
            const inp = "w-full text-center border rounded p-1";
            allSiswa.forEach(s => {
                let n = grades.find(x => x.siswa_id == s.id) || {};
                let v = (val) => (val!==undefined && val!==null) ? val : '';
                
                body.innerHTML += `
                <tr data-sid="${s.id}" class="border-b">
                    <td class="p-3">${s.nama}</td>
                    <td class="p-2"><input type="number" class="inp-hadir ${inp}" value="${v(n.kehadiran)}" oninput="calcRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-tugas ${inp}" value="${v(n.tugas)}" oninput="calcRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-uh1 ${inp}" value="${v(n.uh1)}" oninput="calcRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-uh2 ${inp}" value="${v(n.uh2)}" oninput="calcRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-uh3 ${inp}" value="${v(n.uh3)}" oninput="calcRow(this)"></td>
                    <td class="p-2"><input type="number" class="inp-pas ${inp}" value="${v(n.pas_pat)}" oninput="calcRow(this)"></td>
                    <td class="p-2 text-center font-bold text-blue-600 val-akhir">${v(n.nilai_akhir)}</td>
                </tr>`;
            });
        }

        function calcRow(el) {
            let tr = el.closest('tr');
            let val = (cls) => parseFloat(tr.querySelector(cls).value) || 0;
            // Rumus Rata UH (jika ada isi)
            let uhs = [val('.inp-uh1'), val('.inp-uh2'), val('.inp-uh3')]; // Bisa diperbaiki logikanya
            let uhFilled = uhs.filter(u => u > 0); 
            let uhAvg = uhFilled.length ? uhFilled.reduce((a,b)=>a+b,0)/uhFilled.length : 0;
            
            // Rumus Total
            let final = (val('.inp-hadir')*0.1) + (val('.inp-tugas')*0.2) + (uhAvg*0.4) + (val('.inp-pas')*0.3);
            tr.querySelector('.val-akhir').innerText = final.toFixed(2);
        }

        async function simpanNilaiMapel() {
            const mid = document.getElementById('mapelSelect').value;
            if(!mid) return alert("Pilih Mapel!");
            let rows = document.querySelectorAll('#bodyInputNilai tr');
            let data = [];
            rows.forEach(r => {
                let val = (cls) => r.querySelector(cls).value === '' ? null : parseFloat(r.querySelector(cls).value);
                data.push({
                    siswa_id: r.getAttribute('data-sid'), mapel_id: mid, guru_id: guruId,
                    kehadiran: val('.inp-hadir'), tugas: val('.inp-tugas'),
                    uh1: val('.inp-uh1'), uh2: val('.inp-uh2'), uh3: val('.inp-uh3'), pas_pat: val('.inp-pas'),
                    nilai_akhir: parseFloat(r.querySelector('.val-akhir').innerText)||0
                });
            });
            // Hapus lama insert baru
            await db.from('nilai').delete().eq('mapel_id', mid).in('siswa_id', allSiswa.map(s=>s.id));
            const { error } = await db.from('nilai').insert(data);
            if(error) alert(error.message); else alert("Nilai Tersimpan!");
        }

        // --- FUNGSI EXCEL (Import/Export) ---
        // (Gunakan logika downloadTemplate & importExcel dari kode input.html sebelumnya)
        function downloadTemplate() { alert("Gunakan fungsi downloadTemplate dari input.html sebelumnya disini"); }
        function importExcel(input) { alert("Gunakan fungsi importExcel dari input.html sebelumnya disini"); }

        // --- TAB 3: SIKAP ---
        async function loadSikapView() {
            const { data: cats } = await db.from('catatan_wali').select('*');
            const body = document.getElementById('bodySikap');
            body.innerHTML = '';
            
            const inp = "w-full border rounded p-1 text-center";
            allSiswa.forEach(s => {
                let c = cats.find(x => x.siswa_id == s.id) || {};
                let v = (val) => (val!==undefined && val!==null) ? val : 0;
                
                body.innerHTML += `
                <tr data-sid="${s.id}" class="border-b">
                    <td class="p-3">${s.nama}</td>
                    <td class="p-2"><input type="number" class="inp-sakit ${inp}" value="${v(c.sakit)}"></td>
                    <td class="p-2"><input type="number" class="inp-izin ${inp}" value="${v(c.izin)}"></td>
                    <td class="p-2"><input type="number" class="inp-alpa ${inp}" value="${v(c.alpa)}"></td>
                    <td class="p-2">
                        <select class="inp-akhlak w-full border p-1">
                            <option value="Baik" ${c.akhlak=='Baik'?'selected':''}>Baik</option>
                            <option value="Sangat Baik" ${c.akhlak=='Sangat Baik'?'selected':''}>Sangat Baik</option>
                            <option value="Cukup" ${c.akhlak=='Cukup'?'selected':''}>Cukup</option>
                        </select>
                    </td>
                    <td class="p-2"><input type="text" class="inp-pribadi w-full border p-1" value="${c.kepribadian||''}"></td>
                </tr>`;
            });
        }

        async function simpanSikapMassal() {
            let rows = document.querySelectorAll('#bodySikap tr');
            let data = [];
            rows.forEach(r => {
                data.push({
                    siswa_id: r.getAttribute('data-sid'),
                    sakit: r.querySelector('.inp-sakit').value,
                    izin: r.querySelector('.inp-izin').value,
                    alpa: r.querySelector('.inp-alpa').value,
                    akhlak: r.querySelector('.inp-akhlak').value,
                    kepribadian: r.querySelector('.inp-pribadi').value
                });
            });
            const { error } = await db.from('catatan_wali').upsert(data, {onConflict:'siswa_id'});
            if(error) alert(error.message); else alert("Sikap Tersimpan!");
        }

        // --- UTILS ---
        function switchTab(tab) {
            ['Legger','NilaiMapel','Sikap'].forEach(t => {
                document.getElementById('view'+t).classList.add('hidden');
                document.getElementById('nav'+t).classList.remove('bg-blue-600', 'text-white');
                document.getElementById('nav'+t).classList.add('text-slate-400');
            });
            document.getElementById('view'+tab).classList.remove('hidden');
            document.getElementById('nav'+tab).classList.add('bg-blue-600', 'text-white');
            document.getElementById('nav'+tab).classList.remove('text-slate-400');
            
            if(tab === 'Legger') loadLeggerView();
            if(tab === 'NilaiMapel') loadNilaiMapel(); // Perlu select mapel dulu sebenarnya
            if(tab === 'Sikap') loadSikapView();
        }

        function exportLegger() {
             var table = document.getElementById("leggerTable"); // Pastikan ID table nya benar di HTML Tab 1
             // Logic export excel
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        init();
    </script>
</body>
</html>