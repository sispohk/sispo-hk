<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Wali Kelas - E-Rapot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animasi Transisi Tab */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-2xl z-20">
        <div class="p-6 border-b border-slate-800">
            <h2 class="text-xl font-bold tracking-wide">E-Rapot Wali</h2>
            <p class="text-slate-400 text-xs mt-1 uppercase tracking-wider">Kelas 10A</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('legger')" id="navLegger" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 bg-blue-600 text-white shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                Legger Nilai
            </button>
            <button onclick="switchTab('sikap')" id="navSikap" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                Input Sikap & Absen
            </button>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="flex items-center gap-2 text-slate-400 hover:text-red-400 transition w-full px-4 py-2 text-sm font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                Keluar Aplikasi
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div class="md:hidden bg-white p-4 shadow flex justify-between items-center z-20">
            <h1 class="font-bold text-slate-800">Wali Kelas</h1>
            <button onclick="logout()" class="text-red-500 text-sm">Keluar</button>
        </div>

        <div class="flex-1 overflow-auto p-6 md:p-8 relative">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800" id="pageTitle">Legger Nilai</h1>
                    <p class="text-slate-500 text-sm mt-1">Tahun Ajaran 2025/2026 - Semester Ganjil</p>
                </div>
                
                <div id="actionButtons">
                    <button onclick="exportLegger()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition hover:-translate-y-0.5">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download Excel
                    </button>
                </div>
            </div>

            <div id="viewLegger" class="fade-in block">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left" id="leggerTable">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                                <tr id="tableHeader">
                                    </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-100">
                                <tr><td class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="viewSikap" class="fade-in hidden">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                    <div class="p-4 bg-blue-50 border-b border-blue-100 flex items-center gap-3">
                        <div class="bg-blue-100 p-2 rounded-full text-blue-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <p class="text-sm text-blue-800">Silakan isi data kehadiran dan sikap siswa di bawah ini. Jangan lupa klik <b>Simpan Perubahan</b> setelah selesai.</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-10">No</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-64">Nama Siswa</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-slate-500 uppercase w-20">Sakit</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-slate-500 uppercase w-20">Izin</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-slate-500 uppercase w-20">Alpa</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-48">Akhlak</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">Kepribadian / Catatan</th>
                                </tr>
                            </thead>
                            <tbody id="bodySikap" class="bg-white divide-y divide-slate-100">
                                </tbody>
                        </table>
                    </div>

                    <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex justify-end sticky bottom-0 z-10">
                        <button onclick="simpanSikapMassal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition transform hover:-translate-y-0.5 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                            Simpan Semua Data Sikap
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        <div>
            <h4 class="font-bold text-sm">Berhasil!</h4>
            <p class="text-xs text-slate-300" id="toastMsg">Data berhasil disimpan.</p>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://mpimmgzdwfwvfhefsixr.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1waW1tZ3pkd2Z3dmZoZWZzaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTIzNzksImV4cCI6MjA4MzQyODM3OX0.EGneJjR7IWEyrq8s0mWd5mR9B9B73G5jWyadEY4oHgk'
        const db = supabase.createClient(supabaseUrl, supabaseKey)

        // State Global
        let allSiswa = [];
        let allCatatan = [];
        
        // --- 1. INISIALISASI ---
        async function loadDataMaster() {
            // Tarik Data Siswa Kelas 10A
            const { data: s } = await db.from('siswa').select('*').eq('kelas', '10A').order('nama');
            allSiswa = s;
            
            // Tarik Catatan Wali (Sikap)
            const { data: c } = await db.from('catatan_wali').select('*');
            allCatatan = c || [];

            // Load View Default (Legger)
            loadLeggerView();
        }

        // --- 2. LOGIC VIEW LEGGER ---
        async function loadLeggerView() {
            const { data: mapels } = await db.from('mapel').select('*').order('id');
            const { data: nilais } = await db.from('nilai').select('siswa_id, mapel_id, nilai_akhir');

            // Render Header
            const header = document.getElementById('tableHeader');
            header.innerHTML = `
                <th class="px-4 py-3 text-center w-10">No</th>
                <th class="px-4 py-3 min-w-[200px]">Nama Siswa</th>
                <th class="px-4 py-3 text-center w-24">Cetak</th>
            `;
            mapels.forEach(m => {
                header.innerHTML += `<th class="px-2 py-3 text-center whitespace-nowrap border-l border-slate-200 font-medium">${m.nama_mapel}</th>`;
            });
            header.innerHTML += `<th class="px-2 py-3 text-center font-bold bg-blue-50 text-blue-700 border-l border-slate-200">RERATA</th>`;

            // Render Body
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            allSiswa.forEach((siswa, idx) => {
                let rowHtml = `
                    <td class="px-4 py-3 text-center text-slate-500">${idx + 1}</td>
                    <td class="px-4 py-3 font-medium text-slate-800">${siswa.nama}</td>
                    <td class="px-4 py-3 text-center bg-slate-50">
                        <a href="cetak.html?siswa_id=${siswa.id}" target="_blank" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-white border border-slate-200 hover:bg-emerald-50 hover:border-emerald-200 text-slate-400 hover:text-emerald-600 transition shadow-sm" title="Cetak PDF">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                        </a>
                    </td>
                `;

                let total = 0, count = 0;
                mapels.forEach(m => {
                    let n = nilais.find(x => x.siswa_id == siswa.id && x.mapel_id == m.id);
                    let val = n ? parseFloat(n.nilai_akhir) : null;
                    
                    if (val !== null) {
                        let cls = val < 75 ? "text-red-600 font-bold" : "text-slate-600";
                        rowHtml += `<td class="px-2 py-3 text-center border-l border-slate-100 ${cls}">${Math.round(val)}</td>`;
                        total += val; count++;
                    } else {
                        rowHtml += `<td class="px-2 py-3 text-center border-l border-slate-100 text-slate-300">-</td>`;
                    }
                });

                let avg = count > 0 ? (total/count).toFixed(2) : "0.00";
                rowHtml += `<td class="px-2 py-3 text-center font-bold text-blue-700 bg-blue-50/30 border-l border-slate-200">${avg}</td>`;
                
                let tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-100";
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        // --- 3. LOGIC VIEW SIKAP (BULK INPUT) ---
        function loadSikapView() {
            const tbody = document.getElementById('bodySikap');
            tbody.innerHTML = '';
            
            const inpStyle = "w-full text-center border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 py-1.5 px-2 text-sm";
            const selStyle = "w-full border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 py-1.5 px-2 text-sm bg-white";

            allSiswa.forEach((siswa, idx) => {
                let data = allCatatan.find(c => c.siswa_id == siswa.id) || {};
                
                let val = (v) => (v !== undefined && v !== null) ? v : '';
                let num = (v) => (v !== undefined && v !== null) ? v : 0;
                
                // Pilihan Akhlak
                let akhlakOpt = `
                    <select class="inp-akhlak ${selStyle}">
                        <option value="Sangat Baik" ${data.akhlak === 'Sangat Baik' ? 'selected' : ''}>Sangat Baik</option>
                        <option value="Baik" ${!data.akhlak || data.akhlak === 'Baik' ? 'selected' : ''}>Baik</option>
                        <option value="Cukup" ${data.akhlak === 'Cukup' ? 'selected' : ''}>Cukup</option>
                        <option value="Kurang" ${data.akhlak === 'Kurang' ? 'selected' : ''}>Kurang</option>
                    </select>`;

                let tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-100";
                tr.setAttribute('data-siswa-id', siswa.id);
                
                tr.innerHTML = `
                    <td class="px-6 py-3 text-slate-500">${idx + 1}</td>
                    <td class="px-6 py-3 font-medium text-slate-800">${siswa.nama}</td>
                    <td class="p-2"><input type="number" min="0" class="inp-sakit ${inpStyle}" value="${num(data.sakit)}"></td>
                    <td class="p-2"><input type="number" min="0" class="inp-izin ${inpStyle}" value="${num(data.izin)}"></td>
                    <td class="p-2"><input type="number" min="0" class="inp-alpa ${inpStyle}" value="${num(data.alpa)}"></td>
                    <td class="p-2">${akhlakOpt}</td>
                    <td class="p-2"><input type="text" class="inp-kepribadian w-full border border-slate-300 rounded px-2 py-1.5 text-sm" value="${val(data.kepribadian)}" placeholder="Contoh: Rajin, Disiplin"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. SIMPAN SIKAP MASSAL ---
        async function simpanSikapMassal() {
            let rows = document.querySelectorAll('#bodySikap tr');
            let dataToUpsert = [];
            
            // Animasi tombol loading
            let btn = document.querySelector('button[onclick="simpanSikapMassal()"]');
            let oriHtml = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Menyimpan...`;
            btn.disabled = true;

            rows.forEach(row => {
                let sid = row.getAttribute('data-siswa-id');
                dataToUpsert.push({
                    siswa_id: sid,
                    sakit: parseInt(row.querySelector('.inp-sakit').value) || 0,
                    izin: parseInt(row.querySelector('.inp-izin').value) || 0,
                    alpa: parseInt(row.querySelector('.inp-alpa').value) || 0,
                    akhlak: row.querySelector('.inp-akhlak').value,
                    kepribadian: row.querySelector('.inp-kepribadian').value || '-'
                });
            });

            // Upsert Massal
            const { error } = await db.from('catatan_wali').upsert(dataToUpsert, { onConflict: 'siswa_id' });

            btn.innerHTML = oriHtml;
            btn.disabled = false;

            if (error) {
                alert("Gagal menyimpan: " + error.message);
            } else {
                // Refresh data lokal
                allCatatan = dataToUpsert;
                showToast("Semua data sikap dan kehadiran berhasil disimpan!");
            }
        }

        // --- UI UTILITIES ---
        function switchTab(tab) {
            const btnLegger = document.getElementById('navLegger');
            const btnSikap = document.getElementById('navSikap');
            const viewLegger = document.getElementById('viewLegger');
            const viewSikap = document.getElementById('viewSikap');
            const title = document.getElementById('pageTitle');
            const btnAction = document.getElementById('actionButtons');

            if (tab === 'legger') {
                // Style Active
                btnLegger.className = "w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-600 text-white shadow-md transition-all";
                btnSikap.className = "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all";
                
                // Show/Hide View
                viewLegger.classList.remove('hidden');
                viewSikap.classList.add('hidden');
                
                title.innerText = "Legger Nilai";
                // Show Download Button
                btnAction.innerHTML = `<button onclick="exportLegger()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition hover:-translate-y-0.5"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Download Excel</button>`;
                
                loadLeggerView();
            } else {
                // Style Active
                btnSikap.className = "w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-600 text-white shadow-md transition-all";
                btnLegger.className = "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all";
                
                // Show/Hide View
                viewSikap.classList.remove('hidden');
                viewLegger.classList.add('hidden');
                
                title.innerText = "Input Sikap & Absensi";
                btnAction.innerHTML = ""; // Hide Download Button
                
                loadSikapView();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function exportLegger() {
            var table = document.getElementById("leggerTable");
            var wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "Legger_Lengkap_10A.xlsx");
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        
        loadDataMaster();
    </script>
</body>
</html>